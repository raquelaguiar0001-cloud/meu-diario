<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Lab Master v13.0 - Ci√™ncia Viva</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Orbitron:wght@500;900&display=swap');
        
        :root {
            --rainbow: linear-gradient(180deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff);
            --bio-green: #2ecc71;
            --chem-blue: #3498db;
            --atom-purple: #9b59b6;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            background: radial-gradient(circle at center, #ffffff 0%, #e0f7fa 100%);
            color: #2c3e50;
        }

        /* ELEMENTOS DIN√ÇMICOS DE CI√äNCIAS */
        .science-bg { position: fixed; inset: 0; z-index: -1; pointer-events: none; opacity: 0.15; }
        .dna { position: absolute; width: 100px; animation: rotate 20s linear infinite; }
        .cloud { position: absolute; background: white; border-radius: 50px; opacity: 0.7; filter: blur(10px); animation: float 35s infinite linear; }
        
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes float { from { transform: translateX(-300px); } to { transform: translateX(1300px); } }

        #main-app { display: flex; flex-direction: column; height: 100vh; position: relative; }

        header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 10px 30px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 5px solid var(--chem-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .wrapper { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 20px; }

        /* PAIN√âIS ORGANIZADOS */
        .sidebar { width: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .panel { 
            background: white; border-radius: 20px; border: 2px solid #bdc3c7; 
            overflow: hidden; box-shadow: 6px 6px 0px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .panel-header { 
            padding: 12px 18px; background: #ecf0f1; font-weight: 700; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; color: var(--chem-blue);
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
        }
        .panel-content { padding: 15px; border-top: 1px solid #eee; }
        .panel.closed .panel-content { display: none; }

        /* PISTA DE CORRIDA L√öDICA */
        .track-container { 
            flex: 1; position: relative; background: rgba(255,255,255,0.7); 
            border-radius: 35px; padding: 25px; border: 3px solid white; box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .track { flex: 1; position: relative; overflow-y: auto; height: 90%; scrollbar-width: none; }
        .finish-line { 
            position: absolute; right: 60px; top: 0; bottom: 0; width: 30px; 
            background: var(--rainbow); border-radius: 50px; opacity: 0.8; filter: drop-shadow(0 0 10px rgba(0,0,0,0.2));
        }

        .lane { height: 85px; border-bottom: 2px dashed rgba(52, 152, 219, 0.2); position: relative; display: flex; align-items: center; }
        .runner { position: absolute; transition: 2s cubic-bezier(0.18, 0.89, 0.32, 1.28); text-align: center; z-index: 10; }
        .runner-emoji { font-size: 40px; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2)); cursor: pointer; }
        .runner-tag { background: #2c3e50; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 5px; box-shadow: 0 4px 0 #000; }

        /* COMPONENTES DE NOTAS */
        .student-card { 
            background: white; border-radius: 18px; padding: 15px; margin-bottom: 12px; 
            border: 2px solid #eee; border-left: 8px solid var(--bio-green);
        }
        .check-grid { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--bio-green); cursor: pointer; }
        
        .btn-lab { 
            background: var(--chem-blue); color: white; border: none; padding: 10px; 
            border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-family: 'Orbitron';
        }
        .btn-lab:hover { transform: scale(1.02); background: var(--atom-purple); }

        .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .tab-btn { padding: 8px 15px; border-radius: 12px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: 600; }
        .tab-btn.active { background: var(--chem-blue); color: white; border-color: var(--chem-blue); transform: translateY(-3px); box-shadow: 0 4px 0 #2980b9; }

        .editable:hover { background: #dff9fb; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="science-bg">
        <div class="dna" style="top:10%; left:5%;">üß¨</div>
        <div class="dna" style="top:60%; right:5%; animation-delay: -5s;">‚öõÔ∏è</div>
        <div class="dna" style="top:30%; left:50%; opacity: 0.5;">üß™</div>
    </div>
    <div class="cloud" style="width:250px; height:70px; top:15%; left:10%;"></div>
    <div class="cloud" style="width:350px; height:90px; top:45%; right:10%; animation-delay: 10s;"></div>

    <div id="main-app">
        <header>
            <div style="display:flex; align-items:center; gap:15px;">
                <h1 style="font-family:'Orbitron'; margin:0; font-size:1.2rem; color:var(--chem-blue);">BIO-LAB MASTER</h1>
                <div style="font-size: 0.9rem; font-weight: bold; border-left: 2px solid #ccc; padding-left: 15px;">
                    <span class="editable" id="sch-label" onclick="edL('sch')">Sua Escola</span> | 
                    <span class="editable" id="tea-label" onclick="edL('tea')">Prof¬™ Cientista</span>
                </div>
            </div>
            <button onclick="exportExcel()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:12px; cursor:pointer; font-weight:bold; font-family:'Orbitron'; font-size:0.7rem;">üìä EXTRAIR EXCEL</button>
        </header>

        <div class="wrapper">
            <aside class="sidebar">
                <div class="panel" id="p-cl">
                    <div class="panel-header" onclick="toggleP('p-cl')">üìÇ TURMAS <span>‚ñº</span></div>
                    <div class="panel-content">
                        <div id="class-tabs" class="tabs"></div>
                        <input type="text" id="in-cl" placeholder="+ Nova Turma e pressione Enter" onkeypress="if(event.key==='Enter') addC()">
                    </div>
                </div>

                <div class="panel closed" id="p-sub">
                    <div class="panel-header" onclick="toggleP('p-sub')">üß¨ MAT√âRIAS <span>‚ñº</span></div>
                    <div class="panel-content">
                        <div id="subj-tabs" class="tabs"></div>
                        <input type="text" id="in-sub" placeholder="+ Nova Mat√©ria (ex: Qu√≠mica)" onkeypress="if(event.key==='Enter') addS()">
                    </div>
                </div>

                <div class="panel closed" id="p-crit">
                    <div class="panel-header" onclick="toggleP('p-crit')">üìã CRIT√âRIOS DA TURMA <span>‚ñº</span></div>
                    <div class="panel-content">
                        <div style="background:#f9f9f9; padding:10px; border-radius:12px; margin-bottom:10px; border:1px solid #eee;">
                            <label style="font-size:11px; font-weight:bold;">TOTAL DE VISTOS/ATIVIDADES:</label>
                            <input type="number" id="tot-at" value="10" onchange="upTot(this.value)" style="width:60px; padding:5px; border-radius:5px; border:1px solid #ccc;">
                        </div>
                        <div id="crit-list" style="font-size:12px; margin-bottom:10px;"></div>
                        <input type="text" id="in-crit" placeholder="Outros (Ex: Prova, Maquete)">
                        <button class="btn-lab" onclick="addCrit()" style="font-size:10px;">+ ADICIONAR CRIT√âRIO</button>
                    </div>
                </div>

                <div class="panel" id="p-imp">
                    <div class="panel-header" onclick="toggleP('p-imp')">üë• LISTA DE ALUNOS <span>‚ñº</span></div>
                    <div class="panel-content">
                        <textarea id="in-names" placeholder="Cole os nomes dos alunos aqui..." style="width:100%; height:60px; border-radius:10px; border:1px solid #ccc; padding:10px;"></textarea>
                        <button class="btn-lab" onclick="impSt()" style="margin-top:5px;">IMPORTAR LABORAT√ìRIO</button>
                    </div>
                </div>

                <div id="stu-list-container"></div>
            </aside>

            <main class="track-container">
                <div id="bim-tabs" class="tabs" style="margin-bottom:15px; justify-content:center;"></div>
                <div class="track" id="track">
                    <div class="finish-line"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let state = JSON.parse(localStorage.getItem('biolab_v13')) || { cs: [], ci: -1, b: 1 };
        const emojis = ['üöÄ','‚öõÔ∏è','üß¨','üß™','ü™ê','üõ∏','üëæ','üåø','ü¶†','üî≠'];

        function save() { localStorage.setItem('biolab_v13', JSON.stringify(state)); }
        function toggleP(id) { document.getElementById(id).classList.toggle('closed'); }
        function edL(k) { let n = prompt("Editar:", localStorage.getItem(k)); if(n){ localStorage.setItem(k,n); location.reload(); }}

        function addC() { 
            let v = document.getElementById('in-cl').value; 
            if(v){ state.cs.push({n:v, ss:['Ci√™ncias'], si:0, totA: 10, crits:[], st:[]}); state.ci=state.cs.length-1; document.getElementById('in-cl').value=''; save(); render(); }
        }
        function addS() { let v = document.getElementById('in-sub').value; if(v && state.ci>-1){ state.cs[state.ci].ss.push(v); document.getElementById('in-sub').value=''; save(); render(); }}
        function addCrit() { let v = document.getElementById('in-crit').value; if(v && state.ci>-1){ state.cs[state.ci].crits.push({n:v}); document.getElementById('in-crit').value=''; save(); render(); }}
        function upTot(v) { if(state.ci>-1) { state.cs[state.ci].totA = parseInt(v)||0; save(); render(); } }

        function impSt() {
            let names = document.getElementById('in-names').value.split('\n').filter(x=>x.trim());
            if(state.ci===-1) return;
            names.forEach(n => state.cs[state.ci].st.push({n:n.trim(), emoji: emojis[Math.floor(Math.random()*emojis.length)], sc:{}}));
            state.cs[state.ci].st.sort((a,b)=>a.n.localeCompare(b.n));
            document.getElementById('in-names').value=''; save(); render();
        }

        function getScore(stu) {
            const c = state.cs[state.ci]; if(!c) return 0;
            let sum = 0; let kA = `${c.si}_${state.b}_ativ`;
            let vists = (stu.sc[kA] || []).length;
            sum += c.totA > 0 ? (vists / c.totA) * 10 : 0;
            c.crits.forEach(cr => { let k = `${c.si}_${state.b}_${cr.n}`; sum += parseFloat(stu.sc[k] || 0); });
            return sum / (c.crits.length + 1);
        }

        function render() {
            const c = state.cs[state.ci];
            document.getElementById('class-tabs').innerHTML = state.cs.map((x,i)=>`<button class="tab-btn ${i===state.ci?'active':''}" onclick="state.ci=${i};render()">${x.n}</button>`).join('');
            document.getElementById('bim-tabs').innerHTML = [1,2,3,4].map(b=>`<button class="tab-btn ${b===state.b?'active':''}" onclick="state.b=${b};render()">${b}¬∫ BIMESTRE</button>`).join('');

            if(c) {
                document.getElementById('tot-at').value = c.totA;
                document.getElementById('subj-tabs').innerHTML = c.ss.map((s,i)=>`<button class="tab-btn ${i===c.si?'active':''}" onclick="state.cs[state.ci].si=${i};render()">${s}</button>`).join('');
                document.getElementById('crit-list').innerHTML = c.crits.map((cr,i)=>`<div style="padding:5px; background:#f1f2f6; border-radius:8px; margin-bottom:4px;">üß¨ ${cr.n} <span onclick="state.cs[state.ci].crits.splice(${i},1);save();render()" style="color:red;cursor:pointer;float:right;">‚úñ</span></div>`).join('');

                document.getElementById('stu-list-container').innerHTML = c.st.map((stu, si) => {
                    let kA = `${c.si}_${state.b}_ativ`, checks = '';
                    for(let i=0; i<c.totA; i++) {
                        let ok = (stu.sc[kA] || []).includes(i) ? 'checked' : '';
                        checks += `<input type="checkbox" ${ok} onclick="tglA(${si},'${kA}',${i})">`;
                    }
                    let html = `<div class="student-card">
                        <div style="display:flex; justify-content:space-between;">
                            <b class="editable" onclick="edStu(${si})">${stu.n}</b>
                            <span onclick="delStu(${si})" style="color:#bdc3c7; cursor:pointer">‚úñ</span>
                        </div>
                        <div class="check-grid">${checks}</div>`;
                    c.crits.forEach(cr => {
                        let k = `${c.si}_${state.b}_${cr.n}`;
                        html += `<div style="margin-top:8px; font-size:12px; display:flex; justify-content:space-between; align-items:center;">
                            <span>${cr.n}:</span> <input type="number" value="${stu.sc[k]||0}" onchange="upSc(${si},'${k}',this.value)" style="width:45px; border-radius:5px; border:1px solid #ddd; padding:2px;">
                        </div>`;
                    });
                    return html + `</div>`;
                }).join('');

                const track = document.getElementById('track');
                track.querySelectorAll('.lane').forEach(l=>l.remove());
                c.st.forEach(stu => {
                    let g = getScore(stu);
                    let lane = document.createElement('div'); lane.className='lane';
                    lane.innerHTML = `<div class="runner" style="left:${g*8.5}%">
                        <div class="runner-tag">${stu.n} | ${g.toFixed(1)}</div>
                        <div class="runner-emoji" onclick="changeEmoji(${c.st.indexOf(stu)})">${stu.emoji}</div>
                    </div>`;
                    track.appendChild(lane);
                });
            }
        }

        function tglA(si, k, idx) {
            if(!state.cs[state.ci].st[si].sc[k]) state.cs[state.ci].st[si].sc[k] = [];
            let a = state.cs[state.ci].st[si].sc[k]; let p = a.indexOf(idx);
            if(p > -1) a.splice(p, 1); else a.push(idx);
            save(); render();
        }
        function upSc(si, k, v) { state.cs[state.ci].st[si].sc[k] = parseFloat(v)||0; save(); render(); }
        function edStu(si) { let n = prompt("Nome:", state.cs[state.ci].st[si].n); if(n){state.cs[state.ci].st[si].n=n; save(); render();}}
        function delStu(si) { if(confirm("Remover aluno?")){state.cs[state.ci].st.splice(si,1); save(); render();}}
        function changeEmoji(si) { state.cs[state.ci].st[si].emoji = emojis[Math.floor(Math.random()*emojis.length)]; save(); render(); }

        function exportExcel() {
            const c = state.cs[state.ci]; if(!c) return;
            let csv = `RELAT√ìRIO BIO-LAB\nEscola: ${localStorage.getItem('sch')}\nTurma: ${c.n}\nMat√©ria: ${c.ss[c.si]}\nBimestre: ${state.b}\n\nAluno;M√©dia Final\n`;
            c.st.forEach(s => csv += `${s.n};${getScore(s).toFixed(1)}\n`);
            let b = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
            let a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `Notas_${c.n}.csv`; a.click();
        }

        window.onload = () => {
            document.getElementById('sch-label').innerText = localStorage.getItem('sch') || 'Sua Escola';
            document.getElementById('tea-label').innerText = localStorage.getItem('tea') || 'Prof¬™ Cientista';
            render();
        };
    </script>
</body>
</html>
