<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Bio-Lab v14.7</title>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; padding: 20px; font-size: 20px; }
        .header { background: #1a2a3a; color: #00d2ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .panel { background: white; border: 2px solid #ccc; border-radius: 10px; padding: 15px; margin-bottom: 10px; }
        .student-card { background: #fff; border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 8px; cursor: pointer; }
        .student-card:hover { background: #eef; }
        .track { background: #1a2a3a; height: 300px; position: relative; border-radius: 20px; border: 5px solid white; overflow: hidden; margin-top: 20px; }
        .runner { position: absolute; font-size: 40px; transition: 1s; bottom: 20px; text-align: center; }
        .runner-name { font-size: 12px; color: white; background: rgba(0,0,0,0.5); padding: 2px; border-radius: 4px; }
        .btn { padding: 10px 20px; cursor: pointer; background: #00d2ff; border: none; border-radius: 5px; font-weight: bold; }
        .active { background: #2ecc71; color: white; }
    </style>
</head>
<body>

    <div class="header">
        <div id="labels"><b>ESCOLA:</b> <span id="s-name" onclick="setL('sch')">Clique aqui</span> | <b>PROF:</b> <span id="t-name" onclick="setL('tea')">Clique aqui</span></div>
        <button class="btn" style="background: #27ae60; color:white" onclick="exportCSV()">BAIXAR EXCEL</button>
    </div>

    <div style="display: flex; gap: 20px;">
        <div style="width: 400px;">
            <div class="panel">
                <strong>TURMAS:</strong>
                <div id="class-list" style="margin: 10px 0;"></div>
                <input type="text" id="in-class" placeholder="Nova Turma + Enter" onkeypress="if(event.key==='Enter') addC()" style="width: 90%; padding: 5px;">
            </div>

            <div class="panel">
                <strong>ALUNOS:</strong>
                <textarea id="in-names" placeholder="Cole os nomes..." style="width: 90%; height: 60px; margin-top: 10px;"></textarea>
                <button class="btn" onclick="imp()" style="width: 100%; margin-top: 5px;">IMPORTAR ALUNOS</button>
                <div id="stu-list" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div style="flex: 1;">
            <div id="bim-list" style="display: flex; gap: 10px; margin-bottom: 10px;"></div>
            <div class="track" id="track"></div>
        </div>
    </div>

    <script>
        let data = JSON.parse(localStorage.getItem('biolab_v147')) || { classes: [], cIdx: -1, bim: 1 };

        function save() { localStorage.setItem('biolab_v147', JSON.stringify(data)); render(); }
        function setL(k) { let v = prompt("Digite o nome:"); if(v) { localStorage.setItem(k, v); render(); } }

        function addC() {
            let n = document.getElementById('in-class').value;
            if(n) {
                data.classes.push({ name: n, students: [] });
                data.cIdx = data.classes.length - 1;
                document.getElementById('in-class').value = '';
                save();
            }
        }

        function imp() {
            if(data.cIdx === -1) return alert("Selecione ou crie uma turma primeiro!");
            let ns = document.getElementById('in-names').value.split('\n').filter(x => x.trim());
            ns.forEach(n => data.classes[data.cIdx].students.push({ name: n.trim(), score: 0 }));
            document.getElementById('in-names').value = '';
            save();
        }

        function updateScore(sIdx) {
            let s = prompt("Digite a nota (0 a 10):", data.classes[data.cIdx].students[sIdx].score);
            if(s !== null) {
                data.classes[data.cIdx].students[sIdx].score = parseFloat(s) || 0;
                save();
            }
        }

        function render() {
            document.getElementById('s-name').innerText = localStorage.getItem('sch') || "Sua Escola";
            document.getElementById('t-name').innerText = localStorage.getItem('tea') || "Professor(a)";

            // Render Turmas
            document.getElementById('class-list').innerHTML = data.classes.map((c, i) => 
                `<button class="btn ${i === data.cIdx ? 'active' : ''}" onclick="data.cIdx=${i}; save()" style="margin: 2px;">${c.name}</button>`
            ).join('');

            // Render Bimestres
            document.getElementById('bim-list').innerHTML = [1,2,3,4].map(b => 
                `<button class="btn ${b === data.bim ? 'active' : ''}" onclick="data.bim=${b}; save()">${b}Âº BIM</button>`
            ).join('');

            // Render Alunos e Pista
            let sDiv = document.getElementById('stu-list');
            let tDiv = document.getElementById('track');
            sDiv.innerHTML = '';
            tDiv.innerHTML = '';

            if(data.cIdx > -1) {
                data.classes[data.cIdx].students.forEach((s, i) => {
                    sDiv.innerHTML += `<div class="student-card" onclick="updateScore(${i})"><b>${s.name}</b> - Nota: ${s.score}</div>`;
                    
                    let pos = (s.score / 10) * 85;
                    tDiv.innerHTML += `
                        <div class="runner" style="left: ${pos}%">
                            <div class="runner-name">${s.name}</div>
                            ðŸš€
                        </div>
                    `;
                });
            }
        }

        function exportCSV() {
            if(data.cIdx === -1) return;
            let c = data.classes[data.cIdx];
            let csv = "Aluno;Nota\n" + c.students.map(s => `${s.name};${s.score}`).join('\n');
            let blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Notas_${c.name}.csv`;
            link.click();
        }

        window.onload = render;
    </script>
</body>
</html>
